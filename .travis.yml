dist: xenial
language: python

env:
  - secure: 'O5YOLhJpfJj6cQx+0qi0EAzXwhz4P0w8vCUvvmlPxf8qjiXGkAtHR4aVfpCbWm8c20/1+csnzpiUybhqQ3P7bQUxv9aqmrodp+lhNeBuFEcKjhYwLTpfXuAFktsa344KT6EK3S24R9jDYuTih3BRftUmfNQIbBTaZALTV0CKT44rR05iDTH9Q3akZVWejfFqegUSgn47dhzpKWMCBFXnRxR8s9qi2gbkdAwjLNTP+y4KsTyrt5JPFpy1OJjVVI7JD0aLT3DDLFfukFpleF+8lOIGOMrROevTZQ7RwDQV72nFZAE8U033vWZwG4HJ4RrsR0iyBBCoTcS6hJMQsPF8QnMLp+36tY+JzpHc4m651susHIQe59R2KtdGY+f85/AhPy05v3M1hC47PUphaMeiT57eitJmWnI/X7O5qLE311/JO1QrYPPb3754eQbXQZYB5Myht7tTMw65wmAn/geBeDTXceBz7jsSYORuh4OcD/b8le811PSmFAIvQhq+MXoZuVLU7yyrchh+S9q+nv4Rh7MB0FnmHOKFLzcj4kYLLBMSLHMN5cxNTPuybGopF4/ygGjkyc1mC42DAV1+Du8OTvndnB+XF2QUb8Ol1GMNQgKSQGU7LVDqZDhY/D/CutpbuybXeEYKXw2TX1DNJ92CXSk5o7aN+7qbiyylOCI1CJc='

services:
  - docker

python:
  - 3.6

branches:
  only:
    - master

cache:
  - pip

stages:
  - test
  - push

before_install:
  - uname -a
  - lsb_release -a
  - virtualenv --version
  - python --version
  - docker version
  - travis_retry pip install --upgrade setuptools
  - travis_retry pip install --upgrade pip

install:
  - travis_retry pip install boto3 celery
  - SKIP_DOCKER_PUSH=1 DOCKERFILE_PATH=images/chowder/Dockerfile maint-scripts/docker-build

before_script:
  - '(cd tests; docker-compose up --detach)'

script:
  - PYTHONPATH=./celery-worker python -m unittest discover -v -s tests

jobs:
  include:
    - stage: push
      scripts:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - DOCKERFILE_PATH=images/chowder/Dockerfile maint-scripts/docker-build
